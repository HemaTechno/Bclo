<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>رفع السكربتات</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
    }
    /* أنيميشن لأزرار رفع الصورة */
    .fancy-upload {
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .fancy-upload input[type="file"] {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0; cursor: pointer;
    }
    .fancy-upload:hover {
      background-color: #3b82f6; /* Tailwind blue-500 */
      color: white;
    }
    /* Modal backdrop */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.6);
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
  </style>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body class="bg-gradient-to-tr from-blue-50 to-white min-h-screen flex items-center justify-center p-4">

  <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-3xl w-full fade-in">
    <h2 class="text-3xl font-bold mb-6 text-blue-700 text-center">📜 رفع السكربتات</h2>

    <form id="scriptForm" class="space-y-6">

      <div>
        <label for="scriptName" class="block mb-1 font-semibold text-gray-700">اسم السكربت</label>
        <input type="text" id="scriptName" name="scriptName" required
          class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>

      <div>
        <label for="scriptDesc" class="block mb-1 font-semibold text-gray-700">وصف السكربت</label>
        <textarea id="scriptDesc" name="scriptDesc" required rows="4"
          class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
      </div>

      <div>
        <label for="scriptContent" class="block mb-1 font-semibold text-gray-700">محتوى السكربت (نص)</label>
        <textarea id="scriptContent" name="scriptContent" required rows="8" spellcheck="false"
          class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono resize-none"></textarea>
      </div>

      <!-- زر رفع صورة بشكل أفخم -->
      <div>
        <label class="block mb-1 font-semibold text-gray-700">صورة السكربت (مطلوبة)</label>
        <label for="scriptImage" class="fancy-upload flex items-center justify-center border-2 border-dashed border-blue-400 rounded-xl p-6 text-blue-600 font-semibold hover:border-blue-600 hover:text-blue-700 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M16 12l-4-4m0 0l-4 4m4-4v12" />
          </svg>
          اضغط لاختيار صورة
          <input type="file" id="scriptImage" accept="image/*" required />
        </label>
        <p id="imageName" class="mt-2 text-sm text-gray-600"></p>
      </div>

      <!-- اختيار الماب -->
      <div>
        <label for="mapSelect" class="block mb-1 font-semibold text-gray-700">اختار الماب</label>
        <div class="flex space-x-2">
          <select id="mapSelect" required
            class="flex-grow border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="" disabled selected>-- اختر ماب --</option>
          </select>
          <button type="button" id="addMapBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold px-5 rounded-lg transition transform hover:scale-105">إضافة ماب</button>
        </div>
      </div>

      <!-- reCAPTCHA v2 -->
      <div class="mt-4">
        <div class="g-recaptcha" data-sitekey="YOUR_RECAPTCHA_SITE_KEY"></div>
      </div>

      <button type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold text-lg transition transform hover:scale-105">
        إضافة السكربت
      </button>
    </form>

    <p id="status" class="mt-4 text-center text-sm font-semibold text-red-600"></p>
  </div>

  <!-- Modal إضافة ماب -->
  <div id="mapModal" class="modal-backdrop hidden">
    <div class="bg-white rounded-xl p-6 w-80 max-w-full shadow-xl">
      <h3 class="text-xl font-bold mb-4 text-blue-700">أدخل اسم الماب</h3>
      <input type="text" id="newMapName" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div class="flex justify-end space-x-3">
        <button id="cancelMap" class="bg-gray-300 rounded-lg px-4 py-2 hover:bg-gray-400 transition">إلغاء</button>
        <button id="saveMap" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 transition">حفظ</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, storage } from './db/firebase-config.js';  // عدل هذا حسب مكان ملف config عندك
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
    import {
      collection,
      addDoc,
      doc,
      getDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const form = document.getElementById("scriptForm");
    const status = document.getElementById("status");
    const imageInput = document.getElementById("scriptImage");
    const imageNameDisplay = document.getElementById("imageName");
    const mapSelect = document.getElementById("mapSelect");

    const mapModal = document.getElementById("mapModal");
    const newMapNameInput = document.getElementById("newMapName");
    const addMapBtn = document.getElementById("addMapBtn");
    const cancelMapBtn = document.getElementById("cancelMap");
    const saveMapBtn = document.getElementById("saveMap");

    let currentUser = null;
    let mapsList = [];

    // التحقق من تسجيل الدخول
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      await loadMaps();
    });

    // تحميل المابس من الفايرستور
    async function loadMaps() {
      const mapsCol = collection(db, "maps");
      const q = query(mapsCol, orderBy("createdAt", "asc"));
      const snapshot = await getDocs(q);
      mapsList = [];
      mapSelect.innerHTML = '<option value="" disabled selected>-- اختر ماب --</option>';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        mapsList.push({ id: docSnap.id, name: data.name });
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = data.name;
        mapSelect.appendChild(option);
      });
    }

    // فتح المودال
    addMapBtn.onclick = () => {
      newMapNameInput.value = "";
      mapModal.classList.remove("hidden");
      newMapNameInput.focus();
    };

    cancelMapBtn.onclick = () => {
      mapModal.classList.add("hidden");
    };

    // حفظ الماب جديد
    saveMapBtn.onclick = async () => {
      const name = newMapNameInput.value.trim();
      if (!name) {
        alert("الرجاء إدخال اسم الماب");
        return;
      }
      try {
        // إضافة إلى Firestore مع الطابع الزمني
        const docRef = await addDoc(collection(db, "maps"), {
          name,
          createdAt: serverTimestamp()
        });
        await loadMaps();
        // حدد الماب الجديد تلقائياً في القائمة
        mapSelect.value = docRef.id;
        mapModal.classList.add("hidden");
      } catch (err) {
        alert("حدث خطأ أثناء إضافة الماب: " + err.message);
      }
    };

    // عرض اسم الصورة المحددة
    imageInput.onchange = () => {
      if (imageInput.files.length > 0) {
        imageNameDisplay.textContent = `الصورة المختارة: ${imageInput.files[0].name}`;
      } else {
        imageNameDisplay.textContent = "";
      }
    };

    form.onsubmit = async (e) => {
      e.preventDefault();
      status.textContent = "";
      
      // تحقق من reCAPTCHA
      const recaptchaResponse = grecaptcha.getResponse();
      if (!recaptchaResponse) {
        status.textContent = "يرجى إكمال التحقق البشري (كابتشا)";
        return;
      }

      const name = form.scriptName.value.trim();
      const description = form.scriptDesc.value.trim();
      const content = form.scriptContent.value.trim();
      const selectedMap = mapSelect.value;
      const imageFile = imageInput.files[0];

      if (!name || !description || !content || !selectedMap || !imageFile) {
        status.textContent = "يرجى ملء كل الحقول المطلوبة.";
        return;
      }

      try {
        status.textContent = "جاري رفع الصورة...";
        // رفع الصورة إلى Storage
        const storageRef = ref(storage, `scriptImages/${Date.now()}_${imageFile.name}`);
        await uploadBytes(storageRef, imageFile);
        const imageURL = await getDownloadURL(storageRef);

        status.textContent = "جاري حفظ البيانات...";

        // إنشاء رقم ID تلقائي بسيرفر - نستخدم addDoc الذي يعطينا ID تلقائي
        // يمكن إضافة حقل عداد تحميلات برقم صفر مبدئياً
        await addDoc(collection(db, "scripts"), {
          name,
          description,
          content,
          imageURL,
          mapId: selectedMap,
          createdBy: currentUser.uid,
          createdAt: serverTimestamp(),
          downloads: 0,
        });

        // إعادة تعيين الفورم والـ reCAPTCHA
        form.reset();
        grecaptcha.reset();
        imageNameDisplay.textContent = "";
        status.style.color = "green";
        status.textContent = "تم إضافة السكربت بنجاح 🎉";

      } catch (err) {
        status.style.color = "red";
        status.textContent = "حدث خطأ: " + err.message;
      }
    };
  </script>

</body>
</html>
