<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø±ÙØ¹ Ø³ÙƒØ±Ø¨ØªØ§Øª Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¨</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Cairo', sans-serif; }
    .fade-in { animation: fadeIn 1s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gradient-to-tr from-blue-100 to-white min-h-screen flex items-center justify-center px-4">

  <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-xl fade-in">
    <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">ğŸ“¥ Ø±ÙØ¹ Ø³ÙƒØ±Ø¨Øª Ø¬Ø¯ÙŠØ¯</h2>

    <form id="scriptForm" class="space-y-5" autocomplete="off">
      <div>
        <label for="scriptName" class="block font-semibold mb-1">Ø§Ø³Ù… Ø§Ù„Ø³ÙƒØ±Ø¨Øª</label>
        <input type="text" id="scriptName" required placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø³ÙƒØ±Ø¨Øª"
          class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      </div>

      <div>
        <label for="scriptDescription" class="block font-semibold mb-1">ÙˆØµÙ Ø§Ù„Ø³ÙƒØ±Ø¨Øª</label>
        <textarea id="scriptDescription" required placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø³ÙƒØ±Ø¨Øª" rows="4"
          class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
      </div>

      <div>
        <label for="mapSelect" class="block font-semibold mb-1">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¨</label>
        <select id="mapSelect" class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400">
          <option value="" disabled selected>Ø§Ø®ØªØ± Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø£Ø¶Ù Ø¬Ø¯ÙŠØ¯Ø©</option>
        </select>
        <button type="button" id="addMapBtn" class="mt-2 text-blue-600 hover:underline">+ Ø£Ø¶Ù Ø®Ø±ÙŠØ·Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>

      <div id="newMapContainer" class="hidden mt-2">
        <input type="text" id="newMapName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
          class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-green-400" />
        <button type="button" id="saveNewMapBtn"
          class="mt-2 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-all transform hover:scale-105">Ø­ÙØ¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
      </div>

      <div>
        <label for="scriptFile" class="block font-semibold mb-1">Ù…Ù„Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ù†Øµ Ø£Ùˆ Ù…Ù„Ù)</label>
        <input type="file" id="scriptFile" accept=".png,.js,.json,.ts,.py,.lua,.zip" required class="w-full" />
      </div>

      <div>
        <label for="scriptImage" class="block font-semibold mb-1">ØµÙˆØ±Ø© Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ù…Ø·Ù„ÙˆØ¨)</label>
        <input type="file" id="scriptImage" accept="image/*" required class="w-full" />
      </div>

      <div class="relative">
        <button type="submit"
          class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-all transform hover:scale-105">
          Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
        </button>
        <div id="progressBarContainer" class="absolute bottom-0 left-0 right-0 h-1 bg-gray-300 rounded-b-lg overflow-hidden mt-1 hidden">
          <div id="progressBar" class="h-1 bg-blue-500 w-0 transition-all"></div>
        </div>
      </div>

      <p id="status" class="text-center text-sm text-gray-600 mt-2"></p>
    </form>
  </div>

  <script type="module">
    import { auth, db, storage } from './db/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
    import { collection, addDoc, getDoc, setDoc, doc, query, where, getDocs, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const scriptForm = document.getElementById("scriptForm");
    const status = document.getElementById("status");
    const progressBarContainer = document.getElementById("progressBarContainer");
    const progressBar = document.getElementById("progressBar");
    const mapSelect = document.getElementById("mapSelect");
    const addMapBtn = document.getElementById("addMapBtn");
    const newMapContainer = document.getElementById("newMapContainer");
    const newMapName = document.getElementById("newMapName");
    const saveNewMapBtn = document.getElementById("saveNewMapBtn");

    let currentUser = null;

    // ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        loadMaps();
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±Ø§Ø¦Ø· Ù„Ù„Ù€ select
    async function loadMaps() {
      mapSelect.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø£Ø¶Ù Ø¬Ø¯ÙŠØ¯Ø©</option>';
      const mapsSnapshot = await getDocs(collection(db, "maps"));
      mapsSnapshot.forEach(docSnap => {
        const map = docSnap.data();
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = map.name;
        mapSelect.appendChild(option);
      });
    }

    // Ø¹Ø±Ø¶ input Ø§Ø¶Ø§ÙØ© Ø®Ø±ÙŠØ·Ø© Ø¬Ø¯ÙŠØ¯Ø©
    addMapBtn.addEventListener("click", () => {
      newMapContainer.classList.toggle("hidden");
      newMapName.value = "";
      newMapName.focus();
    });

    // Ø­ÙØ¸ Ø®Ø±ÙŠØ·Ø© Ø¬Ø¯ÙŠØ¯Ø©
    saveNewMapBtn.addEventListener("click", async () => {
      const name = newMapName.value.trim();
      if (!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©");

      // ØªØ­Ù‚Ù‚ Ù„Ùˆ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      const q = query(collection(db, "maps"), where("name", "==", name));
      const qSnap = await getDocs(q);
      if (!qSnap.empty) return alert("Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„");

      const docRef = await addDoc(collection(db, "maps"), { name });
      await loadMaps();
      mapSelect.value = docRef.id;
      newMapContainer.classList.add("hidden");
    });

    // ØªÙˆÙ„ÙŠØ¯ ID Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø³ØªÙ†Ø¯ counters
    async function getNextScriptId() {
      const counterRef = doc(db, "counters", "scripts");
      const counterSnap = await getDoc(counterRef);

      let nextId = 1;
      if (counterSnap.exists()) {
        nextId = counterSnap.data().count + 1;
      }
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
      await setDoc(counterRef, { count: nextId });
      return nextId;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³ÙƒØ±Ø¨Øª Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ù…Ø­ØªÙˆÙ‰ (Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø· Ù‡Ù†Ø§ Ù„Ù„ØªØ¨Ø³ÙŠØ·)
    async function checkDuplicateScript(name) {
      const q = query(collection(db, "scripts"), where("name", "==", name));
      const qSnap = await getDocs(q);
      return !qSnap.empty;
    }

    scriptForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.textContent = "";
      progressBarContainer.classList.add("hidden");
      progressBar.style.width = "0%";

      if (!currentUser) {
        status.textContent = "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.";
        return;
      }

      const name = document.getElementById("scriptName").value.trim();
      const description = document.getElementById("scriptDescription").value.trim();
      const scriptFileInput = document.getElementById("scriptFile");
      const imageFileInput = document.getElementById("scriptImage");
      const selectedMapId = mapSelect.value;

      if (!name || !description || !selectedMapId || scriptFileInput.files.length === 0 || imageFileInput.files.length === 0) {
  status.textContent = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¨ ÙˆØ±ÙØ¹ ØµÙˆØ±Ø©).";
  return;
}
      
const imageFileInput = document.getElementById("scriptImage");
if (imageFileInput.files.length === 0) {
  status.textContent = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„Ù„Ø³ÙƒØ±Ø¨Øª (Ù…Ø·Ù„ÙˆØ¨Ø©).";
  return;
}


      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
      const isDuplicate = await checkDuplicateScript(name);
      if (isDuplicate) {
        status.textContent = "âš ï¸ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ù‡Ø°Ø§ Ù…ÙƒØ±Ø±ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø±ÙØ¹Ù‡.";
        return;
      }

      status.textContent = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª...";

      try {
        const scriptFile = scriptFileInput.files[0];

        // Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ù…Ø¹ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù…
        const scriptFileRef = ref(storage, `scripts/${currentUser.uid}/${Date.now()}_${scriptFile.name}`);
        const uploadTask = uploadBytesResumable(scriptFileRef, scriptFile);

        progressBarContainer.classList.remove("hidden");

        // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…
        uploadTask.on("state_changed", snapshot => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          progressBar.style.width = progress + "%";
        });

        // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        const uploadResult = await uploadTask;

        const scriptURL = await getDownloadURL(uploadResult.ref);

        // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        let imageURL = "";
        if (imageFileInput.files.length > 0) {
          const imageFile = imageFileInput.files[0];
          const imageFileRef = ref(storage, `script-images/${currentUser.uid}/${Date.now()}_${imageFile.name}`);
          await uploadBytesResumable(imageFileRef, imageFile);
          imageURL = await getDownloadURL(imageFileRef);
        }

        // Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const scriptId = await getNextScriptId();

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore
        await addDoc(collection(db, "scripts"), {
          userId: currentUser.uid,
          id: scriptId,
          name,
          description,
          scriptURL,
          imageURL,
          mapId: selectedMapId,
          createdAt: serverTimestamp()
        });

        status.innerHTML = `
          âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ù†Ø¬Ø§Ø­!<br/>
          <button id="copyLinkBtn" class="mt-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙƒØ±Ø¨Øª</button>
        `;

        scriptForm.reset();
        progressBarContainer.classList.add("hidden");
        progressBar.style.width = "0%";

        // Ø±Ø§Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù„ Ø­Ø³Ø¨ Ù…ÙˆÙ‚Ø¹Ùƒ)
        const scriptViewUrl = `${window.location.origin}/view-script.html?id=${scriptId}`;

        // Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
        document.getElementById("copyLinkBtn").addEventListener("click", () => {
          navigator.clipboard.writeText(scriptViewUrl)
            .then(() => alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!"))
            .catch(() => alert("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®ØŒ Ø­Ø§ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹"));
        });

      } catch (error) {
        console.error(error);
        status.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹.";
        progressBarContainer.classList.add("hidden");
        progressBar.style.width = "0%";
      }
    });
  </script>
</body>
</html>
