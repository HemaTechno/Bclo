<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Cairo', sans-serif;
    }
    /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© */
    .fancy-upload {
      position: relative;
      overflow: hidden;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .fancy-upload input[type="file"] {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0; cursor: pointer;
    }
    .fancy-upload:hover {
      background-color: #3b82f6; /* Tailwind blue-500 */
      color: white;
    }
    /* Modal backdrop */
    .modal-backdrop {
      background: rgba(0, 0, 0, 0.6);
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }
  </style>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body class="bg-gradient-to-tr from-blue-50 to-white min-h-screen flex items-center justify-center p-4">

  <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-3xl w-full fade-in">
    <h2 class="text-3xl font-bold mb-6 text-blue-700 text-center">ğŸ“œ Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª</h2>

    <form id="scriptForm" class="space-y-6">

      <div>
        <label for="scriptName" class="block mb-1 font-semibold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø³ÙƒØ±Ø¨Øª</label>
        <input type="text" id="scriptName" name="scriptName" required
          class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>

      <div>
        <label for="scriptDesc" class="block mb-1 font-semibold text-gray-700">ÙˆØµÙ Ø§Ù„Ø³ÙƒØ±Ø¨Øª</label>
        <textarea id="scriptDesc" name="scriptDesc" required rows="4"
          class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
      </div>

      <div>
        <label for="scriptContent" class="block mb-1 font-semibold text-gray-700">Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ù†Øµ)</label>
        <textarea id="scriptContent" name="scriptContent" required rows="8" spellcheck="false"
          class="w-full border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono resize-none"></textarea>
      </div>

      <!-- Ø²Ø± Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¨Ø´ÙƒÙ„ Ø£ÙØ®Ù… -->
      <div>
        <label class="block mb-1 font-semibold text-gray-700">ØµÙˆØ±Ø© Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ù…Ø·Ù„ÙˆØ¨Ø©)</label>
        <label for="scriptImage" class="fancy-upload flex items-center justify-center border-2 border-dashed border-blue-400 rounded-xl p-6 text-blue-600 font-semibold hover:border-blue-600 hover:text-blue-700 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M16 12l-4-4m0 0l-4 4m4-4v12" />
          </svg>
          Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©
          <input type="file" id="scriptImage" accept="image/*" required />
        </label>
        <p id="imageName" class="mt-2 text-sm text-gray-600"></p>
      </div>

      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¨ -->
      <div>
        <label for="mapSelect" class="block mb-1 font-semibold text-gray-700">Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ø§Ø¨</label>
        <div class="flex space-x-2">
          <select id="mapSelect" required
            class="flex-grow border border-gray-300 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ø§Ø¨ --</option>
          </select>
          <button type="button" id="addMapBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold px-5 rounded-lg transition transform hover:scale-105">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¨</button>
        </div>
      </div>

      <!-- reCAPTCHA v2 -->
      <div class="mt-4">
        <div class="g-recaptcha" data-sitekey="YOUR_RECAPTCHA_SITE_KEY"></div>
      </div>

      <button type="submit"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold text-lg transition transform hover:scale-105">
        Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª
      </button>
    </form>

    <p id="status" class="mt-4 text-center text-sm font-semibold text-red-600"></p>
  </div>

  <!-- Modal Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¨ -->
  <div id="mapModal" class="modal-backdrop hidden">
    <div class="bg-white rounded-xl p-6 w-80 max-w-full shadow-xl">
      <h3 class="text-xl font-bold mb-4 text-blue-700">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¨</h3>
      <input type="text" id="newMapName" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div class="flex justify-end space-x-3">
        <button id="cancelMap" class="bg-gray-300 rounded-lg px-4 py-2 hover:bg-gray-400 transition">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="saveMap" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 transition">Ø­ÙØ¸</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db, storage } from './db/firebase-config.js';  // Ø¹Ø¯Ù„ Ù‡Ø°Ø§ Ø­Ø³Ø¨ Ù…ÙƒØ§Ù† Ù…Ù„Ù config Ø¹Ù†Ø¯Ùƒ
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
    import {
      collection,
      addDoc,
      doc,
      getDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const form = document.getElementById("scriptForm");
    const status = document.getElementById("status");
    const imageInput = document.getElementById("scriptImage");
    const imageNameDisplay = document.getElementById("imageName");
    const mapSelect = document.getElementById("mapSelect");

    const mapModal = document.getElementById("mapModal");
    const newMapNameInput = document.getElementById("newMapName");
    const addMapBtn = document.getElementById("addMapBtn");
    const cancelMapBtn = document.getElementById("cancelMap");
    const saveMapBtn = document.getElementById("saveMap");

    let currentUser = null;
    let mapsList = [];

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      await loadMaps();
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¨Ø³ Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø³ØªÙˆØ±
    async function loadMaps() {
      const mapsCol = collection(db, "maps");
      const q = query(mapsCol, orderBy("createdAt", "asc"));
      const snapshot = await getDocs(q);
      mapsList = [];
      mapSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ù…Ø§Ø¨ --</option>';
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        mapsList.push({ id: docSnap.id, name: data.name });
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = data.name;
        mapSelect.appendChild(option);
      });
    }

    // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    addMapBtn.onclick = () => {
      newMapNameInput.value = "";
      mapModal.classList.remove("hidden");
      newMapNameInput.focus();
    };

    cancelMapBtn.onclick = () => {
      mapModal.classList.add("hidden");
    };

    // Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
    saveMapBtn.onclick = async () => {
      const name = newMapNameInput.value.trim();
      if (!name) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¨");
        return;
      }
      try {
        // Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Firestore Ù…Ø¹ Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ
        const docRef = await addDoc(collection(db, "maps"), {
          name,
          createdAt: serverTimestamp()
        });
        await loadMaps();
        // Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        mapSelect.value = docRef.id;
        mapModal.classList.add("hidden");
      } catch (err) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ø¨: " + err.message);
      }
    };

    // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    imageInput.onchange = () => {
      if (imageInput.files.length > 0) {
        imageNameDisplay.textContent = `Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: ${imageInput.files[0].name}`;
      } else {
        imageNameDisplay.textContent = "";
      }
    };

    form.onsubmit = async (e) => {
      e.preventDefault();
      status.textContent = "";
      
      // ØªØ­Ù‚Ù‚ Ù…Ù† reCAPTCHA
      const recaptchaResponse = grecaptcha.getResponse();
      if (!recaptchaResponse) {
        status.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ø´Ø±ÙŠ (ÙƒØ§Ø¨ØªØ´Ø§)";
        return;
      }

      const name = form.scriptName.value.trim();
      const description = form.scriptDesc.value.trim();
      const content = form.scriptContent.value.trim();
      const selectedMap = mapSelect.value;
      const imageFile = imageInput.files[0];

      if (!name || !description || !content || !selectedMap || !imageFile) {
        status.textContent = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.";
        return;
      }

      try {
        status.textContent = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...";
        // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Storage
        const storageRef = ref(storage, `scriptImages/${Date.now()}_${imageFile.name}`);
        await uploadBytes(storageRef, imageFile);
        const imageURL = await getDownloadURL(storageRef);

        status.textContent = "Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… ID ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø³ÙŠØ±ÙØ± - Ù†Ø³ØªØ®Ø¯Ù… addDoc Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø·ÙŠÙ†Ø§ ID ØªÙ„Ù‚Ø§Ø¦ÙŠ
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø¹Ø¯Ø§Ø¯ ØªØ­Ù…ÙŠÙ„Ø§Øª Ø¨Ø±Ù‚Ù… ØµÙØ± Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
        await addDoc(collection(db, "scripts"), {
          name,
          description,
          content,
          imageURL,
          mapId: selectedMap,
          createdBy: currentUser.uid,
          createdAt: serverTimestamp(),
          downloads: 0,
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙˆØ±Ù… ÙˆØ§Ù„Ù€ reCAPTCHA
        form.reset();
        grecaptcha.reset();
        imageNameDisplay.textContent = "";
        status.style.color = "green";
        status.textContent = "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰";

      } catch (err) {
        status.style.color = "red";
        status.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£: " + err.message;
      }
    };
  </script>

</body>
</html>
