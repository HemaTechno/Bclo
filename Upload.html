<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø±ÙØ¹ Ø³ÙƒØ±Ø¨ØªØ§Øª</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
    }
    .fade-in {
      animation: fadeIn 1s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gradient-to-tr from-blue-100 to-white min-h-screen flex items-center justify-center px-4">

  <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-xl fade-in">
    <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">ğŸ“¥ Ø±ÙØ¹ Ø³ÙƒØ±Ø¨Øª Ø¬Ø¯ÙŠØ¯</h2>

    <form id="scriptForm" class="space-y-5">
      <div>
        <label for="scriptName" class="block font-semibold mb-1">Ø§Ø³Ù… Ø§Ù„Ø³ÙƒØ±Ø¨Øª</label>
        <input type="text" id="scriptName" required placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø³ÙƒØ±Ø¨Øª" 
          class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
      </div>

      <div>
        <label for="scriptDescription" class="block font-semibold mb-1">ÙˆØµÙ Ø§Ù„Ø³ÙƒØ±Ø¨Øª</label>
        <textarea id="scriptDescription" required placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø³ÙƒØ±Ø¨Øª" rows="4"
          class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
      </div>

      <div>
        <label for="scriptFile" class="block font-semibold mb-1">Ù…Ù„Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ù†Øµ Ø£Ùˆ Ù…Ù„Ù)</label>
        <input type="file" id="scriptFile" accept=".txt,.js,.json,.ts,.py,.lua,.zip" required
          class="w-full" />
      </div>

      <div>
        <label for="scriptImage" class="block font-semibold mb-1">ØµÙˆØ±Ø© Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input type="file" id="scriptImage" accept="image/*"
          class="w-full" />
      </div>

      <button type="submit" 
        class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-all transform hover:scale-105">
        Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
      </button>

      <p id="status" class="text-center text-sm text-gray-600"></p>
    </form>
  </div>

  <script type="module">
    import { auth, db, storage } from './db/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const scriptForm = document.getElementById("scriptForm");
    const status = document.getElementById("status");

    let currentUser = null;

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
      }
    });

    scriptForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      status.textContent = "";

      if (!currentUser) {
        status.textContent = "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.";
        return;
      }

      const name = document.getElementById("scriptName").value.trim();
      const description = document.getElementById("scriptDescription").value.trim();
      const scriptFileInput = document.getElementById("scriptFile");
      const imageFileInput = document.getElementById("scriptImage");

      if (!name || !description || scriptFileInput.files.length === 0) {
        status.textContent = "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.";
        return;
      }

      status.textContent = "Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª...";

      try {
        // Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª
        const scriptFile = scriptFileInput.files[0];
        const scriptFileRef = ref(storage, `scripts/${currentUser.uid}/${Date.now()}_${scriptFile.name}`);
        await uploadBytes(scriptFileRef, scriptFile);
        const scriptURL = await getDownloadURL(scriptFileRef);

        // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        let imageURL = "";
        if (imageFileInput.files.length > 0) {
          const imageFile = imageFileInput.files[0];
          const imageFileRef = ref(storage, `script-images/${currentUser.uid}/${Date.now()}_${imageFile.name}`);
          await uploadBytes(imageFileRef, imageFile);
          imageURL = await getDownloadURL(imageFileRef);
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore
        await addDoc(collection(db, "scripts"), {
          userId: currentUser.uid,
          name,
          description,
          scriptURL,
          imageURL,
          createdAt: serverTimestamp()
        });

        status.textContent = "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ù†Ø¬Ø§Ø­!";
        scriptForm.reset();
      } catch (error) {
        console.error(error);
        status.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹.";
      }
    });
  </script>

</body>
</html>
