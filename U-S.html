<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="ads" content="no-ads">
    <title>رفع سكربت جديد | ScriptBot</title>
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            min-height: 100vh;
            margin: 0;
            direction: rtl;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        }
        
        .glass-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(230, 230, 230, 1);
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .gradient-text {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .gradient-bg {
            background: var(--primary-gradient);
            transition: transform 0.2s;
        }
        
        .gradient-bg:hover { transform: translateY(-2px); }
        .gradient-bg:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        /* File Upload */
        .file-upload-container {
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            background: #f8fafc;
            transition: all 0.3s;
        }
        .file-upload-container:hover { border-color: #667eea; background: #eff6ff; }
        
        .file-preview { margin-top: 1rem; position: relative; border-radius: 12px; overflow: hidden; }
        .file-preview img { width: 100%; max-height: 200px; object-fit: cover; }
        
        .remove-file {
            position: absolute; top: 10px; left: 10px;
            background: #ef4444; color: white;
            width: 32px; height: 32px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: none;
        }

        /* Tags */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .tag {
            background: #e0e7ff; color: #4338ca;
            padding: 4px 12px; border-radius: 99px; font-size: 0.85rem;
            display: flex; align-items: center; gap: 6px;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid #e2e8f0; border-top-color: #667eea;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Toast */
        .toast {
            position: fixed; top: 20px; right: -100%;
            background: white; padding: 16px; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 12px;
            transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10000;
        }
        .toast.show { right: 20px; }
        
        .error-message { color: #ef4444; font-size: 0.85rem; margin-top: 4px; display: none; }
        .form-group.error .glass-input { border-color: #ef4444; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-700 font-bold" id="loading-text">جاري المعالجة...</p>
    </div>

    <div id="toast" class="toast">
        <i id="toast-icon" class="fas"></i>
        <div id="toast-message" class="text-sm font-medium"></div>
    </div>

    <header class="fixed top-0 w-full z-40 p-4">
        <div class="container mx-auto max-w-6xl">
            <div class="glass-card px-6 py-3 flex justify-between items-center">
                <a href="index.html" class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white">
                        <i class="fas fa-cloud"></i>
                    </div>
                    <span class="text-xl font-bold gradient-text">ScriptBot</span>
                </a>
                <a href="scripts.html" class="text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg transition font-medium">
                    السكربتات
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto mt-28 mb-12 max-w-4xl">
        <div class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                رفع <span class="gradient-text">سكربت</span> جديد
            </h1>
            <p class="text-gray-500">شارك إبداعك مع مجتمعنا بأمان وسرعة</p>
        </div>

        <div class="glass-card p-6 md:p-10">
            <form id="upload-form" class="space-y-6">
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label class="block mb-2 font-semibold text-gray-700">اسم السكربت</label>
                        <input type="text" id="script-name" class="glass-input w-full p-3 rounded-xl focus:outline-none" placeholder="مثال: Blox Fruits Auto Farm" maxlength="100">
                        <div class="error-message" id="script-name-error">الاسم مطلوب (3 أحرف على الأقل)</div>
                    </div>

                    <div class="form-group">
                        <label class="block mb-2 font-semibold text-gray-700">اللعبة</label>
                        <select id="game-select" class="glass-input w-full p-3 rounded-xl focus:outline-none">
                            <option value="">-- اختر اللعبة --</option>
                        </select>
                        <div class="mt-2 flex gap-2">
                            <input type="text" id="new-game" placeholder="أضف لعبة جديدة" class="glass-input flex-1 p-2 rounded-lg text-sm">
                            <button type="button" id="add-game-btn" class="bg-blue-100 text-blue-600 px-4 rounded-lg text-sm font-medium hover:bg-blue-200 transition">إضافة</button>
                        </div>
                        <div class="error-message" id="game-select-error">يرجى اختيار لعبة</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="block mb-2 font-semibold text-gray-700">وصف السكربت</label>
                    <textarea id="script-desc" rows="3" class="glass-input w-full p-3 rounded-xl focus:outline-none" placeholder="اكتب وصفاً مفصلاً للميزات..." maxlength="500"></textarea>
                    <div class="error-message" id="script-desc-error">الوصف مطلوب (10 أحرف على الأقل)</div>
                </div>

                <div class="form-group">
                    <label class="block mb-2 font-semibold text-gray-700">الكود</label>
                    <div class="flex gap-2 mb-2">
                        <button type="button" onclick="window.pasteCode()" class="text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded transition">
                            <i class="fas fa-paste ml-1"></i> لصق
                        </button>
                    </div>
                    <textarea id="script-content" rows="6" class="glass-input w-full p-3 rounded-xl focus:outline-none font-mono text-sm text-left ltr" placeholder="loadstring(game:HttpGet(...))" spellcheck="false" dir="ltr"></textarea>
                    <div class="error-message" id="script-content-error">كود السكربت مطلوب</div>
                </div>

                <div class="form-group">
                    <label class="block mb-2 font-semibold text-gray-700">الوسوم</label>
                    <input type="text" id="tag-input" class="glass-input w-full p-3 rounded-xl focus:outline-none" placeholder="أكتب واضغط Enter (مثال: Auto Farm)">
                    <div class="tags-container" id="tags-container"></div>
                </div>

                <div class="form-group">
                    <label class="block mb-2 font-semibold text-gray-700">صورة توضيحية</label>
                    <div id="file-upload-area" class="file-upload-container">
                        <input type="file" id="script-image" accept="image/*" class="hidden">
                        <div class="text-4xl text-blue-400 mb-3"><i class="fas fa-cloud-upload-alt"></i></div>
                        <p class="text-gray-600 font-medium">اضغط لرفع صورة</p>
                        <p class="text-gray-400 text-sm mt-1">PNG, JPG (الحد الأقصى 5MB)</p>
                    </div>
                    <div id="file-preview" class="file-preview hidden"></div>
                    <div class="error-message" id="script-image-error">صورة السكربت ضرورية</div>
                </div>

                <div class="form-group flex justify-center">
                    <div class="g-recaptcha" data-sitekey="6LcUz1MrAAAAAHXX9VUHoA2jR2oGxjU87Jz8go7i"></div>
                    <div class="error-message text-center" id="captcha-error">يرجى التحقق من أنك لست روبوت</div>
                </div>

                <button type="submit" id="submit-btn" class="gradient-bg text-white w-full py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl transition relative overflow-hidden">
                    <span class="relative z-10">نشر السكربت</span>
                </button>
                
                <div id="form-status"></div>

            </form>
        </div>
    </main>

    <footer class="py-6 text-center text-gray-500 text-sm">
        <p>ScriptBot.cloud © 2026 - جميع الحقوق محفوظة</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
        import { getFirestore, collection, addDoc, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

        // إعدادات فايربيس الخاصة بمشروعك
        const firebaseConfig = {
            apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
            authDomain: "hhhhhh-d4fb8.firebaseapp.com",
            projectId: "hhhhhh-d4fb8",
            storageBucket: "hhhhhh-d4fb8.appspot.com",
            messagingSenderId: "24512338206",
            appId: "1:24512338206:web:dfe045db59bd3434a2110f"
        };

        // تهيئة التطبيق
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // متغيرات الحالة
        let tags = [];
        let selectedFile = null;
        let isUploading = false;

        // العناصر
        const uploadForm = document.getElementById('upload-form');
        const fileUploadArea = document.getElementById('file-upload-area');
        const scriptImage = document.getElementById('script-image');
        const filePreview = document.getElementById('file-preview');
        const tagsContainer = document.getElementById('tags-container');
        const gameSelect = document.getElementById('game-select');
        const loadingOverlay = document.getElementById('loading-overlay');
        const submitBtn = document.getElementById('submit-btn');

        // ==========================================
        //  دوال المساعدة (مربوطة بـ window للوصول العام)
        // ==========================================

        window.showLoading = (msg) => {
            document.getElementById('loading-text').textContent = msg;
            loadingOverlay.classList.remove('hidden');
        };

        window.hideLoading = () => {
            loadingOverlay.classList.add('hidden');
        };

        window.showToast = (msg, type = 'success') => {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const message = document.getElementById('toast-message');
            
            message.textContent = msg;
            toast.className = `toast show ${type === 'success' ? 'border-r-4 border-green-500' : 'border-r-4 border-red-500'}`;
            icon.className = `fas ${type === 'success' ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'} text-xl`;
            
            setTimeout(() => toast.classList.remove('show'), 4000);
        };

        window.showError = (id, msg) => {
            const el = document.getElementById(id);
            if(el) {
                el.textContent = msg;
                el.style.display = 'block';
                el.closest('.form-group')?.classList.add('error');
            }
        };

        window.removeImage = () => {
            selectedFile = null;
            scriptImage.value = '';
            filePreview.innerHTML = '';
            filePreview.classList.add('hidden');
        };

        window.removeTag = (index) => {
            tags.splice(index, 1);
            renderTags();
        };

        window.copyLink = (link) => {
            navigator.clipboard.writeText(link).then(() => window.showToast('تم نسخ الرابط!'));
        };

        window.resetPage = () => {
            window.location.reload();
        };

        window.pasteCode = async () => {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('script-content').value = text;
            } catch (err) {
                window.showToast('لم نتمكن من الوصول للحافظة', 'error');
            }
        };

        function renderTags() {
            tagsContainer.innerHTML = tags.map((tag, i) => `
                <div class="tag">
                    ${tag}
                    <button type="button" onclick="window.removeTag(${i})" class="hover:text-red-500 transition">&times;</button>
                </div>
            `).join('');
        }

        // ==========================================
        //  الأحداث (Event Listeners)
        // ==========================================

        // تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadGames();
            
            // إضافة وسوم
            document.getElementById('tag-input').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') {
                    e.preventDefault();
                    const val = e.target.value.trim();
                    if(val && !tags.includes(val) && tags.length < 10) {
                        tags.push(val);
                        renderTags();
                        e.target.value = '';
                    }
                }
            });

            // رفع الصور
            fileUploadArea.addEventListener('click', () => scriptImage.click());
            
            scriptImage.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(file) handleFileSelect(file);
            });

            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.style.borderColor = '#667eea';
                fileUploadArea.style.backgroundColor = '#eff6ff';
            });

            fileUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                fileUploadArea.style.borderColor = '#cbd5e1';
                fileUploadArea.style.backgroundColor = '#f8fafc';
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.style.borderColor = '#cbd5e1';
                fileUploadArea.style.backgroundColor = '#f8fafc';
                const file = e.dataTransfer.files[0];
                if(file) handleFileSelect(file);
            });
        });

        function handleFileSelect(file) {
            if(!file.type.startsWith('image/')) {
                window.showToast('يرجى رفع ملف صورة فقط', 'error');
                return;
            }
            if(file.size > 5 * 1024 * 1024) { // 5MB
                window.showToast('حجم الصورة كبير جداً', 'error');
                return;
            }
            
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                filePreview.classList.remove('hidden');
                filePreview.innerHTML = `
                    <img src="${e.target.result}" alt="preview">
                    <button type="button" class="remove-file" onclick="window.removeImage()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                // إخفاء رسالة الخطأ إذا وجدت
                const err = document.getElementById('script-image-error');
                if(err) err.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // التحقق من المستخدم
        function checkAuth() {
            onAuthStateChanged(auth, (user) => {
                if(!user) {
                    // console.log("Not Logged In");
                    // window.location.href = 'login.html'; // فعل هذا السطر إذا أردت إجبارهم على الدخول
                }
            });
        }

        // تحميل الألعاب
        async function loadGames() {
            try {
                const querySnapshot = await getDocs(collection(db, "maps"));
                const games = [];
                querySnapshot.forEach(doc => {
                    if(doc.data().name) games.push(doc.data().name);
                });
                
                // تنظيف القائمة وإعادة الملء
                while (gameSelect.options.length > 1) gameSelect.remove(1);
                
                games.sort().forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    gameSelect.appendChild(opt);
                });
            } catch (error) {
                console.error("Error loading games", error);
            }
        }

        // إضافة لعبة جديدة
        document.getElementById('add-game-btn').addEventListener('click', async () => {
            const input = document.getElementById('new-game');
            const name = input.value.trim();
            if(!name) return;
            
            if(!auth.currentUser) {
                window.showToast('يجب تسجيل الدخول لإضافة لعبة', 'error');
                return;
            }

            window.showLoading('جاري إضافة اللعبة...');
            try {
                const id = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
                await setDoc(doc(db, "maps", id), {
                    name: name,
                    createdAt: new Date().toISOString(),
                    createdBy: auth.currentUser.uid
                });
                
                await loadGames();
                gameSelect.value = name;
                input.value = '';
                window.showToast('تمت إضافة اللعبة', 'success');
            } catch(e) {
                window.showToast('فشل إضافة اللعبة', 'error');
            } finally {
                window.hideLoading();
            }
        });

        // ==========================================
        //  عملية الرفع الرئيسية (MAIN SUBMIT)
        // ==========================================
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if(isUploading) return;

            // 1. إعادة تعيين الأخطاء
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.form-group').forEach(el => el.classList.remove('error'));

            // 2. التحقق (Validation)
            let isValid = true;
            const name = document.getElementById('script-name').value.trim();
            const desc = document.getElementById('script-desc').value.trim();
            const content = document.getElementById('script-content').value.trim();
            const game = gameSelect.value;

            if(name.length < 3) { window.showError('script-name-error', 'الاسم قصير جداً'); isValid = false; }
            if(!game) { window.showError('game-select-error', 'يرجى اختيار لعبة'); isValid = false; }
            if(desc.length < 10) { window.showError('script-desc-error', 'الوصف يجب أن يكون 10 أحرف على الأقل'); isValid = false; }
            if(content.length < 5) { window.showError('script-content-error', 'الكود مطلوب'); isValid = false; }
            if(!selectedFile) { window.showError('script-image-error', 'يجب رفع صورة للسكربت'); isValid = false; }

            // التحقق من الكابتشا
            if(window.grecaptcha) {
                const resp = grecaptcha.getResponse();
                if(!resp) {
                    window.showError('captcha-error', 'أثبت أنك لست روبوت');
                    isValid = false;
                }
            }

            if(!isValid) return;

            if(!auth.currentUser) {
                window.showToast('يجب تسجيل الدخول للمتابعة', 'error');
                return;
            }

            // 3. التنفيذ (Execution)
            try {
                isUploading = true;
                submitBtn.disabled = true;
                window.showLoading('جاري رفع السكربت...');

                // رفع الصورة
                const fileName = `${Date.now()}_${selectedFile.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                const imageRef = storageRef(storage, `scripts/images/${fileName}`);
                await uploadBytes(imageRef, selectedFile);
                const imageUrl = await getDownloadURL(imageRef);

                // حفظ البيانات
                const scriptData = {
                    name: name,
                    desc: desc,
                    content: content,
                    game: game,
                    map: game,
                    imageUrl: imageUrl,
                    tags: tags,
                    userId: auth.currentUser.uid,
                    userName: auth.currentUser.displayName || 'مستخدم',
                    status: 'active',
                    views: 0,
                    createdAt: new Date().toISOString()
                };

                const docRef = await addDoc(collection(db, "scripts"), scriptData);
                const scriptLink = `${window.location.origin}/script-view.html?id=${docRef.id}`;

                // 4. عرض النجاح
                const statusDiv = document.getElementById('form-status');
                statusDiv.innerHTML = `
                    <div class="mt-6 p-6 bg-green-50 border border-green-200 rounded-xl text-center animate-pulse-once">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-2xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">تم الرفع بنجاح!</h3>
                        <div class="flex flex-col sm:flex-row gap-3 justify-center mt-6">
                            <button onclick="window.copyLink('${scriptLink}')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition shadow-md">
                                <i class="fas fa-link ml-2"></i> نسخ الرابط
                            </button>
                            <button onclick="window.resetPage()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium transition">
                                رفع سكربت جديد
                            </button>
                        </div>
                    </div>
                `;

                window.showToast('تمت العملية بنجاح!', 'success');
                uploadForm.reset();
                window.removeImage();
                if(window.grecaptcha) grecaptcha.reset();

            } catch (error) {
                console.error("Upload Error:", error);
                window.showToast('حدث خطأ غير متوقع: ' + error.message, 'error');
            } finally {
                // 5. الإنهاء (Cleanup)
                // هذا الكود يعمل دائماً سواء نجحت العملية أو فشلت
                isUploading = false;
                submitBtn.disabled = false;
                window.hideLoading();
            }
        });

    </script>
</body>
</html>
