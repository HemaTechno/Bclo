<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ…</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Cairo', sans-serif; }
    .fade-in { animation: fadeIn 0.8s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    button:hover {
      transform: scale(1.05);
      transition: transform 0.3s ease;
    }
    .custom-file-upload {
      cursor: pointer;
      display: inline-block;
      padding: 5px 10px;
      border-radius: 8px;
      background: linear-gradient(135deg, #4f46e5, #3b82f6);
      color: white;
      font-weight: bold;
      transition: background 0.3s ease;
      font-size: 0.9rem;
    }
    .custom-file-upload:hover {
      background: linear-gradient(135deg, #4338ca, #2563eb);
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #3b82f6;
      color: white;
      padding: 14px 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      opacity: 0;
      animation: fadeInUp 0.5s forwards;
      z-index: 9999;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(-10px); }
    }
  </style>
</head>
<body class="bg-gradient-to-tr from-blue-100 to-white min-h-screen px-4 py-8">

  <!-- Loader -->
  <div id="loader" class="fixed inset-0 bg-white bg-opacity-60 flex items-center justify-center hidden z-50">
    <div class="loader"></div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast hidden"></div>

  <div class="max-w-4xl mx-auto bg-white p-6 rounded-3xl shadow-2xl fade-in">
    <h1 class="text-3xl font-bold text-center mb-6 text-blue-700">ğŸ“‚ Ø³ÙƒØ±Ø¨ØªØ§ØªÙŠ</h1>
    <div id="scriptsContainer" class="space-y-6">
      <!-- Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com",
      messagingSenderId: "24512338206",
      appId: "1:24512338206:web:dfe045db59bd3434a2110f",
      measurementId: "G-HD4R7GNQ5H"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);

    const scriptsContainer = document.getElementById('scriptsContainer');
    const loader = document.getElementById('loader');
    const toast = document.getElementById('toast');

    // ** Ù…Ù‡Ù…: Ù‡Ù†Ø§ ØªØ­ØªØ§Ø¬ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø¨Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ **
    // Ù…Ø«Ø§Ù„: Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Firebase AuthØŒ Ø§Ø³ØªØ®Ø¯Ù… auth.currentUser
    // Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„:
    const currentUser = { uid: "user_123", username: "User123" };

    if (!currentUser) {
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ØªØ­ÙˆÙŠÙ„Ù‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      window.location.href = '/login.html';
    }

    function showToast(message, success = true) {
      toast.textContent = message;
      toast.style.backgroundColor = success ? '#3b82f6' : '#ef4444';
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    async function fetchUserScripts() {
      loader.classList.remove('hidden');
      scriptsContainer.innerHTML = '';
      try {
        const q = query(collection(db, "scripts"), where("userId", "==", currentUser.uid));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) {
          scriptsContainer.innerHTML = '<p class="text-center text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙƒØ±Ø¨ØªØ§Øª Ù„Ø¯ÙŠÙƒ Ø¨Ø¹Ø¯.</p>';
          return;
        }
        querySnapshot.forEach(docSnap => {
          const script = docSnap.data();
          script.id = docSnap.id;
          renderScriptCard(script);
        });
      } catch (error) {
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª", false);
        console.error(error);
      } finally {
        loader.classList.add('hidden');
      }
    }

    function renderScriptCard(script) {
      const card = document.createElement('div');
      card.className = "border border-gray-300 rounded-lg p-5 shadow-sm";

      card.innerHTML = `
        <form data-id="${script.id}" class="space-y-4" enctype="multipart/form-data">
          <div>
            <label class="block mb-1 font-semibold text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø³ÙƒØ±Ø¨Øª</label>
            <input name="name" type="text" required class="w-full border border-gray-300 rounded-lg p-2" value="${escapeHTML(script.name)}" />
          </div>
          <div>
            <label class="block mb-1 font-semibold text-gray-700">Ø§Ù„ÙˆØµÙ</label>
            <textarea name="desc" rows="2" required class="w-full border border-gray-300 rounded-lg p-2">${escapeHTML(script.desc)}</textarea>
          </div>
          <div>
            <label class="block mb-1 font-semibold text-gray-700">Ù†Øµ Ø§Ù„Ø³ÙƒØ±Ø¨Øª</label>
            <textarea name="content" rows="4" required class="w-full border border-gray-300 rounded-lg p-2 font-mono text-sm">${escapeHTML(script.content)}</textarea>
          </div>
          <div>
            <label class="block mb-1 font-semibold text-gray-700">ØµÙˆØ±Ø© Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
            <img src="${script.imageUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø³ÙƒØ±Ø¨Øª" class="w-full max-h-48 object-cover rounded-lg mb-2" />
            <label for="imageInput_${script.id}" class="custom-file-upload">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</label>
            <input id="imageInput_${script.id}" name="image" type="file" accept="image/*" class="hidden" />
            <div class="text-sm mt-1 text-gray-600" id="imageName_${script.id}"></div>
          </div>

          <div class="flex space-x-4 justify-end">
            <button type="button" class="delete-btn px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition">Ø­Ø°Ù</button>
            <button type="submit" class="save-btn px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
          </div>
        </form>
      `;

      scriptsContainer.appendChild(card);

      // ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø®ØªØ§Ø±Ø©
      const imageInput = card.querySelector(`#imageInput_${script.id}`);
      const imageNameDiv = card.querySelector(`#imageName_${script.id}`);
      let newImageFile = null;

      imageInput.addEventListener('change', () => {
        if (imageInput.files.length > 0) {
          const file = imageInput.files[0];
          if (!file.type.startsWith('image/')) {
            showToast('Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„ÙŠØ³ ØµÙˆØ±Ø©!', false);
            imageInput.value = '';
            imageNameDiv.textContent = '';
            newImageFile = null;
            return;
          }
          imageNameDiv.textContent = `ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: ${file.name}`;
          newImageFile = file;
        } else {
          imageNameDiv.textContent = '';
          newImageFile = null;
        }
      });

      // Ø­Ø°Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª
      card.querySelector('.delete-btn').addEventListener('click', async () => {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø°Ù„Ùƒ!')) return;

        loader.classList.remove('hidden');
        try {
          // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
          if (script.imageUrl) {
            const imgRef = storageRef(storage, script.imageUrl.split('/').pop().split('?')[0]);
            try {
              await deleteObject(imgRef);
            } catch (e) {
              // Ø£Ø­ÙŠØ§Ù†Ø§Ù‹ Ù„Ø§ ØªØ­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©ØŒ Ù†ØªØ§Ø¨Ø¹ Ø¨Ø¯ÙˆÙ† Ù…Ø´ÙƒÙ„Ø©
              console.warn("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†:", e);
            }
          }
          // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯
          await deleteDoc(doc(db, "scripts", script.id));

          // Ø§Ø±Ø³Ø§Ù„ ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ Ù„Ù„Ø­Ø°Ù
          await sendDiscordWebhook({
            username: currentUser.username,
            action: 'Ø­Ø°Ù',
            scriptBefore: script,
            scriptAfter: null,
          });

          card.remove();
          showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø¨Ù†Ø¬Ø§Ø­!');
        } catch (error) {
          console.error(error);
          showToast('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª', false);
        } finally {
          loader.classList.add('hidden');
        }
      });

      // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
      card.querySelector('form').addEventListener('submit', async e => {
        e.preventDefault();

        loader.classList.remove('hidden');

        const form = e.target;
        const updatedName = form.name.value.trim();
        const updatedDesc = form.desc.value.trim();
        const updatedContent = form.content.value.trim();

        if (!updatedName || !updatedDesc || !updatedContent) {
          showToast('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', false);
          loader.classList.add('hidden');
          return;
        }

        try {
          let newImageUrl = script.imageUrl;

          if (newImageFile) {
            // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            const newImageRef = storageRef(storage, `scripts_images/${Date.now()}_${newImageFile.name}`);
            await uploadBytes(newImageRef, newImageFile);
            newImageUrl = await getDownloadURL(newImageRef);
          }

          // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Firestore
          const scriptDocRef = doc(db, "scripts", script.id);
          const scriptBeforeUpdate = {...script}; // Ù†Ø³Ø®Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„

          await updateDoc(scriptDocRef, {
            name: updatedName,
            desc: updatedDesc,
            content: updatedContent,
            imageUrl: newImageUrl
          });

          // Ø¥Ø±Ø³Ø§Ù„ ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
          await sendDiscordWebhook({
            username: currentUser.username,
            action: 'ØªØ¹Ø¯ÙŠÙ„',
            scriptBefore: scriptBeforeUpdate,
            scriptAfter: { name: updatedName, desc: updatedDesc, content: updatedContent, imageUrl: newImageUrl }
          });

          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
          newImageFile = null;
          imageNameDiv.textContent = '';

          // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
          script.name = updatedName;
          script.desc = updatedDesc;
          script.content = updatedContent;
          script.imageUrl = newImageUrl;

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
          form.querySelector('img').src = newImageUrl;

        } catch (error) {
          console.error(error);
          showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª', false);
        } finally {
          loader.classList.add('hidden');
        }
      });
    }

    // Ø¯Ø§Ù„Ø© ØªØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ù…Ù†Ø¹ Ù…Ø´Ø§ÙƒÙ„ XSS Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØµÙˆØµ
    function escapeHTML(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, m => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[m]);
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ (Ø§Ø³ØªØ¨Ø¯Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ)
    async function sendDiscordWebhook({ username, action, scriptBefore, scriptAfter }) {
      const webhookUrl = "https://discord.com/api/webhooks/WEBHOOK_ID/WEBHOOK_TOKEN";

      let description = `**${action} Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:** \`${username}\`\n`;

      if (action === 'ØªØ¹Ø¯ÙŠÙ„') {
        description += `**Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:**\n` +
          `> Ø§Ù„Ø§Ø³Ù…: ${scriptBefore.name}\n` +
          `> Ø§Ù„ÙˆØµÙ: ${scriptBefore.desc}\n` +
          `> Ù†Øµ Ø§Ù„Ø³ÙƒØ±Ø¨Øª: ${scriptBefore.content.substring(0, 50)}...\n` +
          `> [ØµÙˆØ±Ø© Ù‚Ø¯ÙŠÙ…Ø©](${scriptBefore.imageUrl})\n\n` +
          `**Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:**\n` +
          `> Ø§Ù„Ø§Ø³Ù…: ${scriptAfter.name}\n` +
          `> Ø§Ù„ÙˆØµÙ: ${scriptAfter.desc}\n` +
          `> Ù†Øµ Ø§Ù„Ø³ÙƒØ±Ø¨Øª: ${scriptAfter.content.substring(0, 50)}...\n` +
          `> [ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©](${scriptAfter.imageUrl})\n`;
      } else if (action === 'Ø­Ø°Ù') {
        description += `**ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙ:**\n` +
          `> Ø§Ù„Ø§Ø³Ù…: ${scriptBefore.name}\n` +
          `> Ø§Ù„ÙˆØµÙ: ${scriptBefore.desc}\n` +
          `> Ù†Øµ Ø§Ù„Ø³ÙƒØ±Ø¨Øª: ${scriptBefore.content.substring(0, 50)}...\n` +
          `> [Ø§Ù„ØµÙˆØ±Ø©](${scriptBefore.imageUrl})\n`;
      }

      const payload = {
        username: "Bot - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª",
        embeds: [{
          title: `ØªÙ… ${action} Ø³ÙƒØ±Ø¨Øª`,
          description: description,
          color: action === 'ØªØ¹Ø¯ÙŠÙ„' ? 3066993 : 15158332,
          timestamp: new Date().toISOString(),
          footer: {
            text: `Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØ§Øª`
          }
        }]
      };

      try {
        await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
      } catch (error) {
        console.warn("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆÙŠØ¨ Ù‡ÙˆÙƒ:", error);
      }
    }

    fetchUserScripts();
  </script>

</body>
</html>
